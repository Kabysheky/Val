<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KASH_PROTOCOL_V14</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    
    <style>
        :root { --neon: #0f0; --love: #ff007f; }
        body { margin: 0; background: #000; color: var(--neon); font-family: 'Courier New', monospace; overflow: hidden; }
        
        /* SCANLINES */
        .crt-bg { position: fixed; inset: 0; z-index: 5; pointer-events: none; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); background-size: 100% 3px, 3px 100%; }

        .ui-screen { position: fixed; inset: 0; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        .terminal-box { border: 2px solid var(--neon); padding: 30px; width: 85%; background: rgba(0,0,0,0.9); box-shadow: 0 0 40px var(--neon); text-align: center; }
        
        /* MANUAL BYPASS BUTTON - TOP LEFT */
        #override-btn { 
            position: fixed; top: 20px; left: 20px; 
            z-index: 5000; /* Extremely high z-index to stay on top */
            background: rgba(0,0,0,0.7); border: 2px solid var(--neon); 
            color: var(--neon); padding: 12px; font-size: 11px; 
            cursor: pointer; font-weight: bold; width: auto;
        }

        /* MEDIA CONTROLS */
        .media-controls { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 2005; display: flex; gap: 8px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid var(--neon); }
        .ctrl-btn { background: transparent; border: 1px solid var(--neon); color: var(--neon); padding: 8px; font-size: 10px; cursor: pointer; }
        
        #progress-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 6px; background: #222; z-index: 2006; }
        #progress-bar { width: 0%; height: 100%; background: var(--neon); }

        /* THE LETTER */
        #letter-screen { position: fixed; inset: 0; z-index: 6000; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; }
        .letter-content { background: #fff; color: #333; padding: 30px; width: 80%; border-radius: 5px; font-family: serif; line-height: 1.5; }

        #final-stage { display: none; opacity: 0; background: radial-gradient(circle, #300030 0%, #000 100%); z-index: 7000; }
        #final-stage.active { display: flex; opacity: 1; }

        .hidden { display: none !important; }
        button:active { filter: brightness(1.5); }
    </style>
</head>
<body>

    <div class="crt-bg"></div>

    <div id="auth" class="ui-screen">
        <div class="terminal-box">
            <div style="font-size: 1.5rem; margin-bottom: 20px;">KASH_PROTOCOL</div>
            <input type="password" id="pass" placeholder="SYNC_PIN" style="background:transparent; border:none; border-bottom:2px solid var(--neon); color:var(--neon); text-align:center; font-size:2rem; width: 60%; outline:none;" inputmode="numeric">
            <button onclick="checkKey()" style="background:var(--neon); color:#000; border:none; padding:20px; width:100%; margin-top:20px; font-weight:900;">DECRYPT</button>
        </div>
    </div>

    <div id="start-prompt" class="ui-screen hidden">
        <div class="terminal-box">
            <p>CONNECTION_ESTABLISHED</p>
            <button onclick="startExperience()" style="background:var(--neon); color:#000; border:none; padding:20px; width:100%; font-weight:900;">INITIALIZE AR HUD</button>
        </div>
    </div>

    <div id="experience" class="hidden">
        <button id="override-btn" onclick="manualPlay()">[BYPASS_SYNC]</button>
        
        <a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;" 
                 renderer="colorManagement: true; exposure: 2;"
                 vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
            
            <a-assets> <video id="vid" src="montage.mp4" preload="auto" crossorigin="anonymous" playsinline webkit-playsinline></video> </a-assets>

            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
            
            <a-entity mindar-image-target="targetIndex: 0">
                <a-video src="#vid" width="1" height="0.6" position="0 0 0.1"></a-video>
                <a-text value="I LOVE YOU" color="#ff007f" align="center" width="5" position="0 0.65 0.2"></a-text>
                <a-entity geometry="primitive: torus; radius: 0.7; tube: 0.005" material="color: #0f0; opacity: 0.5" rotation="90 0 0"></a-entity>
            </a-entity>
        </a-scene>

        <div class="media-controls">
            <button class="ctrl-btn" onclick="togglePlay()">PAUSE/PLAY</button>
            <button class="ctrl-btn" onclick="toggleMute()">SOUND</button>
            <button class="ctrl-btn" onclick="restartVid()">RESET</button>
        </div>
        <div id="progress-container"><div id="progress-bar"></div></div>
    </div>

    <div id="letter-screen">
        <div class="letter-content">
            <p>My Dearest [Name],</p>
            <p>I wanted to show you how much you mean to me. You are my heart's reality. I love you.</p>
            <button onclick="closeLetter()" style="background:var(--love); color:white; border:none; padding:15px; width:100%; margin-top:10px;">PROCEED TO FINAL ASSET</button>
        </div>
    </div>

    <div id="final-stage" class="ui-screen">
        <div class="terminal-box">
            <h2 style="color: var(--love);">KASH_COMPLETE</h2>
            <model-viewer id="gift-viewer" src="gift.glb" ar ar-modes="scene-viewer quick-look" 
                camera-controls auto-rotate exposure="2.5" style="width:100%; height:300px;">
                <button slot="ar-button" style="background:var(--love); color:white; padding:15px; border-radius:5px; border:none; width:90%;">MATERIALIZE HEART</button>
            </model-viewer>
        </div>
    </div>

    <script>
        const v = document.getElementById('vid');
        const exp = document.getElementById('experience');
        const fin = document.getElementById('final-stage');
        const letter = document.getElementById('letter-screen');
        const prog = document.getElementById('progress-bar');

        function checkKey() {
            if(document.getElementById('pass').value === '0203') {
                document.getElementById('auth').classList.add('hidden');
                document.getElementById('start-prompt').classList.remove('hidden');
            }
        }

        function startExperience() {
            document.getElementById('start-prompt').classList.add('hidden');
            exp.classList.remove('hidden');
            v.muted = false; v.play();
            document.querySelector('a-scene').systems["mindar-image-system"].start();
        }

        // THE BYPASS FUNCTION
        function manualPlay() {
            // Force the video to take over the whole screen
            v.style.cssText = "position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:5500; object-fit:contain; background:#000;";
            document.body.appendChild(v);
            v.play();
            document.getElementById('override-btn').style.display = 'none';
        }

        function togglePlay() { v.paused ? v.play() : v.pause(); }
        function toggleMute() { v.muted = !v.muted; }
        function restartVid() { v.currentTime = 0; v.play(); }

        v.ontimeupdate = () => {
            prog.style.width = (v.currentTime / v.duration) * 100 + "%";
            if (v.currentTime > 0 && v.currentTime >= v.duration - 0.4) { showLetter(); }
        };

        function showLetter() {
            v.pause();
            exp.classList.add('hidden');
            letter.style.display = 'flex';
        }

        function closeLetter() {
            letter.style.display = 'none';
            fin.classList.add('active');
        }
    </script>
</body>
</html>
